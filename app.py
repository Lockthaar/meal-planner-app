# app.py

import streamlit as st
import sqlite3
import pandas as pd
import json
from collections import defaultdict
from typing import Optional
import io

# ----------------------------------------------------------------
# 1) SET_PAGE_CONFIG (TOUJOURS EN T√äTE) ET CSS POUR LE STYLE
# ----------------------------------------------------------------
st.set_page_config(
    page_title="üçΩÔ∏è Meal Planner",
    page_icon="üç¥",
    layout="wide",
)

# Petit CSS pour masquer le menu Streamlit et le footer, 
# et pour ajuster l‚Äôapparence des titres et expandeurs.
st.markdown(
    """
    <style>
        /* Masquer le menu hamburger en haut √† droite */
        # MainMenu {visibility: hidden;}
        /* Masquer le footer ‚ÄúMade with Streamlit‚Äù */
        footer {visibility: hidden;}
        /* Changer la police et la couleur des headers */
        h1, .st-b {font-family: 'Arial', sans-serif; color: #FFA500;}
        /* Style pour les expanders (bordure, ombre l√©g√®re) */
        .streamlit-expanderHeader {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .css-1outpf7 {
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
        }
    </style>
    """,
    unsafe_allow_html=True
)

# ----------------------------------------------------------------
# 2) TITRE PRINCIPAL + LOGO (SI VOUS AVEZ UNE IMAGE, CHANGEZ LE LIEN)
# ----------------------------------------------------------------
st.markdown(
    """
    <div style="display: flex; align-items: center; gap:10px;">
        <img src="https://img.icons8.com/fluency/48/000000/cutlery.png" width="48">
        <h1 style="margin: 0;">üç¥ Meal Planner Application</h1>
    </div>
    <p style="font-size:1rem; color:#555; margin-top: -5px;">
        Organisez vos repas, g√©rez vos recettes et g√©n√©rez votre liste de courses en un clin d‚Äô≈ìil !
    </p>
    <hr>
    """,
    unsafe_allow_html=True,
)

# ----------------------------------------------------------------
# 3) BASE DE DONN√âES SQLITE (COMPTES, RECETTES, PLANNINGS)
# ----------------------------------------------------------------
DB_PATH = "meal_planner.db"

def get_connection():
    """Cr√©e (si besoin) et retourne une connexion √† la base SQLite."""
    conn = sqlite3.connect(DB_PATH, check_same_thread=False)
    return conn

def init_db():
    """Cr√©e les tables users, recipes et mealplans si elles n‚Äôexistent pas."""
    conn = get_connection()
    cursor = conn.cursor()

    # Table users : id, username, password (en clair pour l‚Äôexemple ‚Äî √† ne pas faire en prod)
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password TEXT NOT NULL
    )
    """)

    # Table recipes : id, user_id, name, ingredients_JSON, instructions
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS recipes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        ingredients TEXT NOT NULL,
        instructions TEXT,
        FOREIGN KEY(user_id) REFERENCES users(id)
    )
    """)

    # Table mealplans : id, user_id, day, meal, recipe_name
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS mealplans (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        day TEXT NOT NULL,
        meal TEXT NOT NULL,
        recipe_name TEXT NOT NULL,
        FOREIGN KEY(user_id) REFERENCES users(id)
    )
    """)

    conn.commit()
    conn.close()

def add_user(username: str, password: str) -> bool:
    """
    Tente d‚Äôajouter un nouvel utilisateur.
    Retourne True si succ√®s, False si le username existe d√©j√†.
    """
    conn = get_connection()
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO users(username, password) VALUES(?, ?)",
            (username, password)
        )
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        return False
    finally:
        conn.close()

def verify_user(username: str, password: str) -> Optional[int]:
    """
    V√©rifie que le couple (username, password) est valide.
    Si oui, retourne l‚Äôuser_id. Sinon, retourne None.
    """
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "SELECT id FROM users WHERE username = ? AND password = ?",
        (username, password)
    )
    row = cursor.fetchone()
    conn.close()
    if row:
        return row[0]
    return None

def get_recipes_for_user(user_id: int) -> pd.DataFrame:
    """
    R√©cup√®re toutes les recettes pour cet user_id sous forme de DataFrame.
    Colonnes : ['id', 'name', 'ingredients', 'instructions']
    """
    conn = get_connection()
    df = pd.read_sql_query(
        "SELECT id, name, ingredients, instructions FROM recipes WHERE user_id = ?",
        conn,
        params=(user_id,)
    )
    conn.close()
    return df

def insert_recipe(user_id: int, name: str, ingredients_json: str, instructions: str):
    """Ins√®re une nouvelle recette pour cet utilisateur."""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO recipes(user_id, name, ingredients, instructions) VALUES(?, ?, ?, ?)",
        (user_id, name, ingredients_json, instructions)
    )
    conn.commit()
    conn.close()

def delete_recipe(recipe_id: int):
    """Supprime la recette dont l‚ÄôID est recipe_id."""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute("DELETE FROM recipes WHERE id = ?", (recipe_id,))
    conn.commit()
    conn.close()

def get_mealplan_for_user(user_id: int) -> pd.DataFrame:
    """
    R√©cup√®re le planning de l‚Äôutilisateur sous forme de DataFrame.
    Colonnes : ['id', 'day', 'meal', 'recipe_name']
    """
    conn = get_connection()
    df = pd.read_sql_query(
        "SELECT id, day, meal, recipe_name FROM mealplans WHERE user_id = ?",
        conn,
        params=(user_id,)
    )
    conn.close()
    return df

def upsert_mealplan(user_id: int, plan_df: pd.DataFrame):
    """
    Remplace (supprime + r√©ins√®re) tout le planning pour cet user_id.
    Pour simplifier, on efface d‚Äôabord tout, puis on r√©ins√®re toutes les lignes.
    """
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute("DELETE FROM mealplans WHERE user_id = ?", (user_id,))
    conn.commit()
    for _, row in plan_df.iterrows():
        cursor.execute(
            "INSERT INTO mealplans(user_id, day, meal, recipe_name) VALUES(?, ?, ?, ?)",
            (user_id, row["Day"], row["Meal"], row["Recipe"])
        )
    conn.commit()
    conn.close()

# Fonction de parsage JSON ‚Üî liste d‚Äôingr√©dients
@st.cache_data
def parse_ingredients(ing_str: str):
    try:
        return json.loads(ing_str)
    except:
        return []

# Initialise la base (cr√©ation des tables si n√©cessaire)
init_db()

# ----------------------------------------------------------------
# 4) AUTHENTIFICATION : GESTION DE LA CONNEXION / INSCRIPTION
# ----------------------------------------------------------------
# On stocke user_id et username dans session_state pour ‚Äúsession login‚Äù
if "user_id" not in st.session_state:
    st.session_state.user_id = None
if "username" not in st.session_state:
    st.session_state.username = ""

# Initialisation du compteur de lignes d‚Äôingr√©dients (recettes)
if "ing_count" not in st.session_state:
    st.session_state.ing_count = 1

def show_login_page():
    """
    Affiche le formulaire de Connexion / Inscription.
    Si la connexion r√©ussit, on met √† jour st.session_state.user_id.
    """
    st.subheader("üîí Connexion / Inscription")
    tab1, tab2 = st.tabs(["üîê Connexion", "‚úçÔ∏è Inscription"])

    # --- Onglet Connexion ---
    with tab1:
        st.write("Connectez-vous pour acc√©der √† vos recettes et plannings.")
        login_user = st.text_input("Nom d'utilisateur", key="login_username", placeholder="Ex. : mon_login")
        login_pwd  = st.text_input("Mot de passe", type="password", key="login_password", placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢")
        if st.button("Se connecter", key="login_button", use_container_width=True):
            uid = verify_user(login_user.strip(), login_pwd)
            if uid:
                st.session_state.user_id = uid
                st.session_state.username = login_user.strip()
                st.success(f"Bienvenue, **{login_user.strip()}** ! Vous √™tes connect√©.")
                # On ne force plus le rerun ici, on laisse le script continuer naturellement
            else:
                st.error("‚ùå Nom d‚Äôutilisateur ou mot de passe incorrect.")

    # --- Onglet Inscription ---
    with tab2:
        st.write("Cr√©ez votre compte pour commencer √† enregistrer vos recettes.")
        new_user = st.text_input("Nom d'utilisateur souhait√©", key="register_username", placeholder="Ex. : mon_profil")
        new_pwd  = st.text_input("Mot de passe", type="password", key="register_password", placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢")
        confirm_pwd = st.text_input("Confirmez le mot de passe", type="password", key="register_confirm", placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢")
        if st.button("Cr√©er mon compte", key="register_button", use_container_width=True):
            if not new_user.strip():
                st.error("‚ùå Le nom d‚Äôutilisateur ne peut pas √™tre vide.")
            elif new_pwd != confirm_pwd:
                st.error("‚ùå Les mots de passe ne correspondent pas.")
            else:
                ok = add_user(new_user.strip(), new_pwd)
                if ok:
                    st.success("‚úÖ Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.")
                else:
                    st.error(f"‚ùå Le nom d‚Äôutilisateur ¬´ {new_user.strip()} ¬ª existe d√©j√†.")

# Affiche d‚Äôabord la page de login/inscription
show_login_page()

# Tant que l‚Äôutilisateur n‚Äôest pas connect√©, on stoppe le reste
if st.session_state.user_id is None:
    st.stop()

# ----------------------------------------------------------------
# 5) L‚ÄôUTILISATEUR EST CONNECT√â : on affiche le reste de l‚Äôapplication
# ----------------------------------------------------------------
USER_ID = st.session_state.user_id

# Barre lat√©rale : infos utilisateur + d√©connexion + navigation
with st.sidebar:
    st.markdown("---")
    st.write(f"üë§ **Connect√© en tant que : {st.session_state.username}**")
    if st.button("üîì Se d√©connecter", use_container_width=True):
        # On vide la session et on recharge la page pour revenir au login
        del st.session_state.user_id
        del st.session_state.username
        st.experimental_rerun()
    st.markdown("---")
    st.write("üóÇÔ∏è **Navigation :**")
    section = st.radio(
        label="Aller √†‚Ä¶",
        options=["Mes recettes", "Planificateur", "Liste de courses", "Impression"],
        index=0
    )
    st.markdown("---")
    st.info(
        """
        üí° Astuces :  
        - Cr√©ez d‚Äôabord vos recettes,  
        - Puis planifiez la semaine,  
        - Et g√©n√©rez la liste de courses automatiquement !
        """
    )

# ----------------------------------------------------------------
# FONCTIONNALIT√âS PAR SECTION
# ----------------------------------------------------------------

# Section ‚ÄúMes recettes‚Äù
if section == "Mes recettes":
    st.header("üìã Mes recettes")
    st.markdown("Ajoutez, consultez ou supprimez vos recettes personnelles.")

    # 5.1 ‚Äì Formulaire d‚Äôajout de recette
    with st.expander("‚ûï Ajouter une nouvelle recette", expanded=True):
        col1, col2 = st.columns([2, 1])
        with col1:
            name = st.text_input("Nom de la recette", key="new_name", placeholder="Ex. : Poulet au curry")
        with col2:
            # Permet d‚Äôajouter dynamiquement plusieurs lignes d‚Äôingr√©dients
            st.write("**Lignes d‚Äôingr√©dients :**")
            if st.button("‚ûï Ajouter une ligne", key="add_ing", use_container_width=True):
                st.session_state.ing_count += 1

        # Affiche les lignes en fonction de ing_count
        ingr√©dients_temp = []
        unit√©s_dispo = ["mg", "g", "kg", "cl", "dl", "l", "pi√®ce(s)"]

        for i in range(st.session_state.ing_count):
            c1, c2, c3 = st.columns([4, 2, 2])
            with c1:
                ingr_i = st.text_input(f"Ingr√©dient #{i+1}", key=f"ing_nom_{i}", placeholder="Ex. : Farine")
            with c2:
                qty_i = st.number_input(f"Quantit√© #{i+1}", min_value=0.0, format="%.2f", key=f"ing_qty_{i}")
            with c3:
                unit_i = st.selectbox(f"Unit√© #{i+1}", unit√©s_dispo, key=f"ing_unit_{i}")
            ingr√©dients_temp.append((ingr_i, qty_i, unit_i))

        instructions = st.text_area("Instructions (facultatif)", key="new_instructions", placeholder="D√©crivez ici la pr√©paration‚Ä¶")

        if st.button("üíæ Enregistrer la recette", key="save_recipe", use_container_width=True):
            df_recettes = get_recipes_for_user(USER_ID)
            if not name.strip():
                st.error("‚ùå Le nom de la recette ne peut pas √™tre vide.")
            elif name.strip() in df_recettes["name"].tolist():
                st.error(f"‚ùå Vous avez d√©j√† une recette appel√©e ¬´ {name.strip()} ¬ª.")
            else:
                # Filtrage des ingr√©dients valides (nom non vide + qty > 0)
                ingr√©dients_list = []
                for ingr_i, qty_i, unit_i in ingr√©dients_temp:
                    if ingr_i.strip() != "" and qty_i > 0:
                        ingr√©dients_list.append({
                            "ingredient": ingr_i.strip(),
                            "quantity": float(qty_i),
                            "unit": unit_i
                        })

                if len(ingr√©dients_list) == 0:
                    st.error("‚ùå Veuillez remplir au moins un ingr√©dient valide (nom + quantit√© > 0).")
                else:
                    ing_json = json.dumps(ingr√©dients_list, ensure_ascii=False)
                    insert_recipe(USER_ID, name.strip(), ing_json, instructions.strip())
                    st.success(f"‚úÖ Recette ¬´ {name.strip()} ¬ª ajout√©e avec succ√®s.")

                    # R√©initialisation du formulaire
                    if "new_name" in st.session_state:
                        del st.session_state["new_name"]
                    if "new_instructions" in st.session_state:
                        del st.session_state["new_instructions"]
                    for j in range(st.session_state.ing_count):
                        for field in (f"ing_nom_{j}", f"ing_qty_{j}", f"ing_unit_{j}"):
                            if field in st.session_state:
                                del st.session_state[field]
                    st.session_state.ing_count = 1

                    st.experimental_rerun()

    st.markdown("---")

    # 5.2 ‚Äì Affichage des recettes existantes en expanders individuels
    df_recettes = get_recipes_for_user(USER_ID)
    if df_recettes.empty:
        st.info("Vous n‚Äôavez (encore) aucune recette enregistr√©e. Utilisez le formulaire ci-dessus pour en ajouter !")
    else:
        st.markdown("### üìñ Liste de vos recettes")
        for _, row in df_recettes.iterrows():
            with st.expander(f"üìù {row['name']}", expanded=False):
                colon1, colon2 = st.columns([3, 1])
                with colon1:
                    st.markdown("**Ingr√©dients :**")
                    for ing in parse_ingredients(row["ingredients"]):
                        st.write(f"- {ing['ingredient']}: {ing['quantity']} {ing['unit']}")
                    st.markdown("**Instructions :**")
                    st.write(row["instructions"] or "_Aucune instruction pr√©cis√©e._")
                with colon2:
                    if st.button("üóëÔ∏è Supprimer la recette", key=f"delete_recipe_{row['id']}", use_container_width=True):
                        delete_recipe(row["id"])
                        st.success(f"‚ùå Recette ¬´ {row['name']} ¬ª supprim√©e.")
                        st.experimental_rerun()
                st.markdown("---")

# Section ‚ÄúPlanificateur‚Äù
elif section == "Planificateur":
    st.header("üìÖ Planifier mes repas")
    st.markdown("Choisissez une recette pour chaque jour, pour chaque type de repas.")

    df_recettes = get_recipes_for_user(USER_ID)
    choix_recettes = [""] + df_recettes["name"].tolist()

    days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"]
    meals = ["Petit-d√©jeuner", "D√©jeuner", "D√Æner"]

    with st.form(key="plan_form", clear_on_submit=False):
        cols = st.columns(3)
        selections = []
        for i, day in enumerate(days):
            col = cols[0] if i < 3 else (cols[1] if i < 6 else cols[2])
            with col:
                st.subheader(f"üóì {day}")
                for meal in meals:
                    recipe_choice = st.selectbox(f"{meal} :", choix_recettes, key=f"{day}_{meal}")
                    selections.append((day, meal, recipe_choice))

        if st.form_submit_button("üíæ Enregistrer le planning", use_container_width=True):
            df_plan = pd.DataFrame(selections, columns=["Day", "Meal", "Recipe"])
            df_plan = df_plan[df_plan["Recipe"] != ""].reset_index(drop=True)
            upsert_mealplan(USER_ID, df_plan)
            st.success("‚úÖ Planning de la semaine enregistr√©.")
            st.experimental_rerun()

    st.markdown("---")
    st.write("### üè† Votre planning actuel")
    df_current_plan = get_mealplan_for_user(USER_ID)
    if df_current_plan.empty:
        st.info("Vous n‚Äôavez pas encore de planning. Utilisez le formulaire ci-dessus pour en cr√©er un.")
    else:
        st.table(
            df_current_plan[["day", "meal", "recipe_name"]].rename(
                columns={"day": "Jour", "meal": "Repas", "recipe_name": "Recette"}
            )
        )

# Section ‚ÄúListe de courses‚Äù
elif section == "Liste de courses":
    st.header("üõí Liste de courses g√©n√©r√©e")
    st.markdown("La liste est automatiquement compil√©e d‚Äôapr√®s votre planning.")

    df_current_plan = get_mealplan_for_user(USER_ID)
    if df_current_plan.empty:
        st.info("Planifiez d‚Äôabord vos repas pour g√©n√©rer la liste de courses.")
    else:
        total_ingredients = defaultdict(lambda: {"quantity": 0, "unit": ""})
        df_recettes = get_recipes_for_user(USER_ID)
        for _, row_plan in df_current_plan.iterrows():
            recette_name = row_plan["recipe_name"]
            row_rec = df_recettes[df_recettes["name"] == recette_name]
            if not row_rec.empty:
                ing_list = parse_ingredients(row_rec.iloc[0]["ingredients"])
                for ing in ing_list:
                    cl√© = ing["ingredient"]
                    qty = ing["quantity"]
                    unit = ing["unit"]
                    if total_ingredients[cl√©]["unit"] and total_ingredients[cl√©]["unit"] != unit:
                        st.warning(f"‚ö†Ô∏è Unit√© diff√©rente pour ¬´ {cl√©} ¬ª, v√©rifiez manuellement.")
                    total_ingredients[cl√©]["quantity"] += qty
                    total_ingredients[cl√©]["unit"] = unit

        shopping_data = [
            {"Ingr√©dient": ing, "Quantit√©": vals["quantity"], "Unit√©": vals["unit"]}
            for ing, vals in total_ingredients.items()
        ]
        shopping_df = pd.DataFrame(shopping_data)

        st.table(shopping_df)

        # Ajout d‚Äôun bouton pour t√©l√©charger la liste en CSV
        towrite = io.StringIO()
        shopping_df.to_csv(towrite, index=False, sep=";")
        towrite.seek(0)
        st.download_button(
            label="‚§ì T√©l√©charger la liste en CSV",
            data=towrite,
            file_name="liste_de_courses.csv",
            mime="text/csv",
        )

# Section ‚ÄúImpression‚Äù
else:  # section == "Impression"
    st.header("üñ®Ô∏è Liste de courses imprimable")
    st.markdown("Affichez simplement la liste, puis imprimez la page (Ctrl+P / Cmd+P).")

    df_current_plan = get_mealplan_for_user(USER_ID)
    if df_current_plan.empty:
        st.info("Planifiez d‚Äôabord vos repas pour obtenir la liste de courses.")
    else:
        total_ingredients = defaultdict(lambda: {"quantity": 0, "unit": ""})
        df_recettes = get_recipes_for_user(USER_ID)
        for _, row_plan in df_current_plan.iterrows():
            recette_name = row_plan["recipe_name"]
            row_rec = df_recettes[df_recettes["name"] == recette_name]
            if not row_rec.empty:
                ing_list = parse_ingredients(row_rec.iloc[0]["ingredients"])
                for ing in ing_list:
                    cl√© = ing["ingredient"]
                    qty = ing["quantity"]
                    unit = ing["unit"]
                    total_ingredients[cl√©]["quantity"] += qty
                    total_ingredients[cl√©]["unit"] = unit

        shopping_data = [
            {"Ingr√©dient": ing, "Quantit√©": vals["quantity"], "Unit√©": vals["unit"]}
            for ing, vals in total_ingredients.items()
        ]
        shopping_df = pd.DataFrame(shopping_data)

        st.markdown("---")
        st.write("## üìù Liste de courses")
        st.table(shopping_df)

        st.markdown(
            """
            <div style="text-align:center; margin-top:20px;">
                <i>Appuyez sur <b>Ctrl+P</b> (Windows) ou <b>‚åò+P</b> (Mac) pour imprimer cette page.</i>
            </div>
            """,
            unsafe_allow_html=True
        )
